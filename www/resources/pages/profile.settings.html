<!--suppress JSAnnotator -->
<template>
    <!-- Page, data-name contains page name which can be used in callbacks -->
    <div class="page " > <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                    </a>
                </div>
                <div class="title sliding">{{@global.LANGUAGE.MENU_MSG01}}</div>
                <div class="right">
                    <label for="{{CurrentFormButtonSubmit}}" class="link icon-only">
                        <i class="f7-icons icon-apply"></i>
                    </label>
                </div>
            </div>
        </div>

        <div class="toolbar tabbar toolbar-top">
            <div class="toolbar-inner">
                <a href="#tab1" class="tab-link tab-link-active">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG00}}</a>
                <a href="#tab2" class="tab-link">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG01}}</a>
            </div>
        </div>

        <div class="tabs-animated-wrap">
            <div class="tabs">
                <form id="tab1" name="user-profile-form" class="tab page-content tab-active">
                    <input type="submit" id="submit-form-user" class="display-none" />
                    <div class="block-title">{{@global.LANGUAGE.REGISTRATION_MSG15}}</div>
                    <div class="list no-hairline-bottom">
                        <ul>
                            <li class="item-content bg-color-lightgray">
                                <div class="item-media text-color-gray"><i class="f7-icons icon-name"></i></div>
                                <div class="item-inner">
                                    <div class="item-title">
                                        <div class="item-header text-color-gray">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG13}}</div>
                                        {{certNumber}}
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-input disabled">
                                <div class="item-media text-color-lightgray"><i class="f7-icons icon-phone"></i></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG05}}</div>
                                    <div class="item-input-wrap">
                                        <input type="tel" name="PhoneNumber" value="{{phoneNumber}}"  >
                                        <!-- <span class="input-clear-button"></span>-->
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-input disabled">
                                <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-name"></i>--></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG02}}</div>
                                    <div class="item-input-wrap">
                                        <input type="text" name="FirstName" value="{{firstName}}" >
                                       <!-- <span class="input-clear-button"></span>-->
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-input disabled">
                                <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-name"></i>--></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG03}}</div>
                                    <div class="item-input-wrap">
                                        <input type="text" name="SubName" value="{{subName}}" >
                                        <!--<span class="input-clear-button"></span>-->
                                    </div>
                                </div>
                            </li>
                            <li >
                                <a class="item-link smart-select smart-select-init smart-select-gender disabled" data-open-in="popover" data-close-on-select="true" data-form-color-theme="green">
                                    <select name="Gender" >
                                        {{#each GenderList}}
                                        <option value="{{Val}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                        {{/each}}
                                    </select>
                                    <div class="item-content">
                                        <div class="item-media text-color-lightgray">
                                            <!-- <i class="material-icons">favorite_border</i>-->
                                        </div>
                                        <div class="item-inner">
                                            <div class="item-title ">{{@global.LANGUAGE.REGISTRATION_MSG07}}</div>
                                        </div>
                                    </div>
                                </a>
                            </li>

                            <li>
                                <div class="item-content item-input disabled">
                                    <div class="item-media text-color-lightgray">
                                        <!-- <i class="material-icons">favorite_border</i>-->
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title item-label color-gray">{{@global.LANGUAGE.REGISTRATION_MSG08}}</div>
                                        <div class="item-input-wrap">
                                            <input type="text" placeholder="Select Birth Date" readonly="readonly" name="BirthDate"/>
                                        </div>
                                    </div>
                                </div>
                            </li>

                        </ul>
                    </div>

                    <div class="block-title">{{@global.LANGUAGE.REGISTRATION_MSG16}}</div>
                    <div class="list no-hairline-bottom">
                        <ul>
                            <li>
                                <a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-scroll-to-selected-item="true" data-form-color-theme="green" data-virtual-list="true" data-virtual-list-height="48">
                                    <select name="ProvinceCity" required validate>
                                        {{#each ProvinceCityList}}
                                        <optgroup label="{{Name}}">
                                            {{#each List}}
                                            <option value="{{CityId}}" data-province-id="{{ProvinceId}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                            {{/each}}
                                        </optgroup>
                                        {{/each}}
                                    </select>
                                    <div class="item-content">
                                        <div class="item-media text-color-lightgray">
                                            <i class="f7-icons icon-tracking"></i>
                                        </div>
                                        <div class="item-inner">
                                            <div class="item-title ">{{@global.LANGUAGE.REGISTRATION_MSG10}}</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li class="item-content item-input ">
                                <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-name"></i>--></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.REGISTRATION_MSG12}}</div>
                                    <div class="item-input-wrap">
                                        <input type="text" name="Street" value="{{street}}" required validate>
                                        <!--<span class="input-clear-button"></span>-->
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-input ">
                                <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-name"></i>--></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.REGISTRATION_MSG13}}</div>
                                    <div class="item-input-wrap">
                                        <input type="text" name="AddressDetails" value="{{address}}"  required validate>
                                        <!--<span class="input-clear-button"></span>-->
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="block-title">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG07}}</div>
                    <div class="list no-hairline-bottom">
                        <ul>
                            {{#EmergencyList}}
                            <span class="em-contact-wrapper" data-id="{{Id}}">
                                <li class="item-content item-input">
                                    <div class="item-media text-color-lightgray"><i class="f7-icons icon-name"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG08}}</div>
                                        <div class="item-input-wrap">
                                            <input type="text" name="EmContactName" placeholder="Name" value='{{Name}}' >
                                            <span class="input-clear-button"></span>
                                        </div>
                                    </div>
                                </li>
                                <li class="item-content item-input">
                                    <div class="item-media text-color-lightgray"><i class="f7-icons icon-phone"></i></div>
                                    <div class="item-inner">
                                        <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG05}}</div>
                                        <div class="item-input-wrap">
                                            <input type="tel" name="EmContactPhone" placeholder="+13001234512" value='{{Phone}}' >
                                            <span class="input-clear-button"></span>
                                        </div>
                                    </div>
                                </li>
                            </span>
                            {{/EmergencyList}}
                        </ul>
                    </div>
                </form>

                <form id="tab2" name="user-password-form" class="tab page-content">
                    <input type="submit" id="submit-form-password" class="display-none" />
                    <div class="block-title tooltip-init" data-tooltip="{{@global.LANGUAGE.PROMPT_MSG052}}">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG12}} <span class="badge color-lightblue">?</span></div>
                    <div class="list no-hairlines">
                        <ul>
                            <li class="item-content item-input">
                                <div class="item-media text-color-lightgray"><i class="f7-icons icon-password"></i></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG09}}</div>
                                    <div class="item-input-wrap">
                                        <input type="password" name="OldPassword" value="" required validate>
                                        <span class="input-clear-button"></span>
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-input">
                                <div class="item-media text-color-lightgray"><i class="f7-icons icon-password"></i></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG10}}</div>
                                    <div class="item-input-wrap">
                                        <input type="password" name="NewPassword" value="" pattern="^\\S+\\w{4,32}\\S{1,}" minlength="6" maxlength="32" required validate>
                                        <span class="input-clear-button"></span>
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-input">
                                <div class="item-media text-color-lightgray"><i class="f7-icons icon-password"></i></div>
                                <div class="item-inner">
                                    <div class="item-title item-label">{{@global.LANGUAGE.PROFILE_SETTINGS_MSG11}}</div>
                                    <div class="item-input-wrap">
                                        <input type="password" name="NewPasswordConfirm" value="" minlength="6" required validate>
                                        <span class="input-clear-button"></span>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>
        </div>

    </div>



</template>


<script>
    // script must return component object
    return {
        data: function () {
            let self = this;

            let userInfo = self.$app.methods.getFromStorage('userInfo');
            let emListSaved = self.$app.methods.getFromStorage('emergencyList');
            let provinceCityList = Helper.Methods.getProvinceCityList();

            let genderList = Helper.Methods.getGenderList();


            genderList.find( ({ Val }) => Val === userInfo.gender ).Selected = true;

            let emList = [
                {
                    Id: '',
                    Name: '',
                    Phone: '',
                },
                {
                    Id: '',
                    Name: '',
                    Phone: '',
                },
                {
                    Id: '',
                    Name: '',
                    Phone: '',
                },
            ];
            if(emListSaved && emListSaved.length){
                for (let i = 0; i < emListSaved.length; i++) {
                    emList[i] = emListSaved[i];
                }
            }
            console.log(userInfo.provinceID)
            let province = provinceCityList.find( ({ Id }) => Id === userInfo.provinceID );
            province.List.find( ({ CityId }) => CityId === userInfo.cityID ).Selected = true;
            let ret = {
                ...userInfo,
                CurrentFormButtonSubmit: 'submit-form-user',
                EmergencyList: emList,
                ProvinceCityList: provinceCityList,
                GenderList: genderList,
            };

            //console.log(ret)
            return ret;
        },

        methods: {
            saveUserDetails: function (data) {
                var self = this;

                self.$app.preloader.show();
                self.$app.request.promise.get(API_URL.EDIT_ACCOUNT, data, 'json')
                        .then(function (result) {
                            if(result.data.majorCode === '000') {
                                var userInfo = self.$app.methods.getFromStorage('userInfo');
                                self.$app.utils.extend(userInfo, result.data.data);
                                self.$app.methods.setInStorage({name: 'userInfo', data: userInfo});
                                self.$app.methods.customNotification({text: LANGUAGE.PROMPT_MSG014});
                                self.$app.view.main.router.back();
                            }else if(result.data.data && typeof result.data.data == 'string' ){
                                self.$app.methods.customDialog({ title: LANGUAGE.PROMPT_MSG071, text: result.data.data });
                            }else if(result.data.majorCode && result.data.data && result.data.data.length){
                                let errMsg = '';
                                for (let i = 0; i < result.data.data.length; i++) {
                                    if(result.data.data[i].messages.length){
                                        errMsg += result.data.data[i].key + ' - ' + result.data.data[i].messages.join(", ") + '<br>';
                                    }
                                }
                                self.$app.methods.customDialog({ title: LANGUAGE.PROMPT_MSG071, text: errMsg });
                            }else{
                                self.$app.methods.customDialog({ text: LANGUAGE.PROMPT_MSG003 });
                            }
                        })
                        .finally(function () {
                            self.$app.preloader.hide();
                        })
                        .catch(function (err) {
                            console.log(err);
                            if (err && err.status === 404) {
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG002);
                            } else {
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG003);
                            }
                        });
            },
            saveNewPassword: function (data) {
                var self = this;

                self.$app.preloader.show();
                self.$app.request.promise.post(API_URL.CHANGE_PASSWORD, data, 'json')
                    .then(function (result) {
                        if(result.data.majorCode === '000') {
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG055, function(){
                                self.$app.methods.logout();
                                self.$app.view.main.router.back();
                            });
                        }else if(result.data.majorCode === '001'){
                            let errMsg = '';
                            for (let i = 0; i < result.data.data.length; i++) {
                                if(result.data.data[i].key === 'currentpassword'){
                                    if(result.data.data[i].messages[0] === '0007'){
                                        self.$app.methods.customDialog({ text: LANGUAGE.PROMPT_MSG056 });
                                        return;
                                    }
                                }
                                if(result.data.data[i].messages.length){
                                    errMsg += result.data.data[i].key + ' - ' + result.data.data[i].messages.join(", ") + '<br>';
                                }
                            }
                            self.$app.methods.customDialog({ title: LANGUAGE.PROMPT_MSG071, text: errMsg });
                        }else{
                            self.$app.methods.customDialog({ text: LANGUAGE.PROMPT_MSG003 });
                        }
                    })
                    .finally(function () {
                        self.$app.preloader.hide();
                    })
                    .catch(function (err) {
                        console.log(err);
                        if (err && err.status === 404){
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG002);
                        }else{
                            self.$app.dialog.alert(LANGUAGE.PROMPT_MSG003);
                        }
                    });

            },
        },
        on: {
            pageInit: function (e, page) {
                let self = this;
                let profileForm = page.$pageEl.find('[name = "user-profile-form"]');
                let passwordForm = page.$pageEl.find('[name = "user-password-form"]');
                let tabs = page.$pageEl.find('.tab');
                let birth = moment(self.birthday, window.COM_TIMEFORMAT2).format(window.COM_TIMEFORMAT5);
                birth = birth.split('-');
                let provinceCityEl = page.$el.find('[name = "ProvinceCity"]')[0];
                //self.PickerBirthDate.setValue(birth);

                self.PickerBirthDate = self.$app.picker.create({
                    backdrop: true,
                    inputEl: page.$el.find('[name="BirthDate"]'),
                    value: birth,
                    formatValue: function (values, displayValues) {
                        //return displayValues[0] + ' ' + values[1] + ', ' + values[2] + ' ' + values[3] + ':' + values[4];
                        return values[0] + '/' + values[1] + '/' + values[2];
                    },
                    cols: [
                        // Days
                        {
                            values: ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31'],
                            textAlign: 'left'
                        },
                        // Months
                        {
                            values: ['01','02','03','04','05','06','07','08','09','10','11','12'],
                            displayValues: [LANGUAGE.COM_MSG046, LANGUAGE.COM_MSG047, LANGUAGE.COM_MSG048, LANGUAGE.COM_MSG049, LANGUAGE.COM_MSG050, LANGUAGE.COM_MSG051, LANGUAGE.COM_MSG052, LANGUAGE.COM_MSG053, LANGUAGE.COM_MSG054, LANGUAGE.COM_MSG055, LANGUAGE.COM_MSG056, LANGUAGE.COM_MSG057],
                            textAlign: 'center'
                        },
                        // Years
                        {
                            values: (function () {
                                var arr = [];
                                for (var i = 1920; i <= 2020; i++) { arr.push(i); }
                                return arr;
                            })(),
                            textAlign: 'right'
                        },
                    ]
                });

                tabs.on('tab:show', function(){
                    if (this.name === 'user-password-form') {
                        self.$setState({
                            CurrentFormButtonSubmit: 'submit-form-password'
                        });
                    }else{
                        self.$setState({
                            CurrentFormButtonSubmit: 'submit-form-user'
                        });
                    }
                });

                profileForm.on('submit', function (e) {
                    e.preventDefault();

                    let emNames = page.$el.find('[name="EmContactName"]');
                    let emPhones = page.$el.find('[name="EmContactPhone"]');

                    if(emNames && emNames.length){
                        let emList = [];
                        for (let i = 0; i < emNames.length; i++) {
                            if(emNames[i].value && emPhones[i] && emPhones[i].value){
                                let id = $$(emNames[i]).closest('.em-contact-wrapper').data('id');
                                emList.push({
                                    Id: !id ? self.$app.utils.id() : id,
                                    Name: emNames[i].value,
                                    Phone: emPhones[i].value,
                                });
                            }
                        }
                        self.$app.methods.setInStorage({name: 'emergencyList', data: emList});
                    }

                   /* self.$app.methods.customNotification({text:LANGUAGE.PROMPT_MSG014});
                    self.$app.view.main.router.back();*/


                    let data = {
                        Token: self.$app.data.Token,
                        ProvinceID: $$(provinceCityEl.options[provinceCityEl.selectedIndex]).data('province-id'),
                        CityID: provinceCityEl.value,
                       /* ProvinceID: page.$el.find('[name="Province"]').val(),
                        CityID: page.$el.find('[name="City"]').val(),*/
                        //RegionID: page.$el.find('input[name="SubName"]').val(),
                        Street: page.$el.find('input[name="Street"]').val(),
                        Address: page.$el.find('input[name="AddressDetails"]').val(),
                    };


                    self.saveUserDetails(data);

                    return false;
                });

                passwordForm.on('submit', function (e) {
                    e.preventDefault();

                    let data = {
                        Token: self.$app.data.Token,
                        CurrentPassword: page.$el.find('input[name="OldPassword"]').val(),
                        NewPassword: page.$el.find('input[name="NewPassword"]').val(),
                    };

                    let confirmpwd = page.$el.find('input[name="NewPasswordConfirm"]').val();

                    if (data.NewPassword.length < 6) {
                        self.$app.methods.customDialog({text:LANGUAGE.PROMPT_MSG054});
                        return false;
                    }
                    if (data.NewPassword !== confirmpwd) {
                        self.$app.methods.customDialog({text:LANGUAGE.PROMPT_MSG053});
                        return false;
                    }

                    self.saveNewPassword(data);

                    return false;
                });
            },
        }
    }
</script>
