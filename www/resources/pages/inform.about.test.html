<!--suppress JSAnnotator -->
<template>
    <!-- Page, data-name contains page name which can be used in callbacks -->
    <div class="page " > <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                    </a>
                </div>
                <div class="title sliding">{{@global.LANGUAGE.INFORM_ABOUT_MSG00}}</div>
                <div class="right">
                    {{#unless DiagnoseStateAwaitingReview}}
                    <label for="submit-test-send" class="link icon-only">
                        <i class="f7-icons icon-apply"></i>
                    </label>
                    {{/unless}}
                </div>
            </div>
        </div>


        <div  class="page-content" >
         <!--   <div class="block-title">{{@global.LANGUAGE.DEVICE_SHARE_MSG00}}</div>-->
            {{#unless DiagnoseStateAwaitingReview}}
            <div class="block">
                {{@global.LANGUAGE.PROMPT_MSG033}}
            </div>
            {{else}}
            <div class="block text-color-red">
                {{@global.LANGUAGE.PROMPT_MSG037}}
            </div>
            {{/unless}}

            <form name="FormTestSend" class="list no-hairlines no-margin-bottom {{#if DiagnoseStateAwaitingReview}}disabled{{/if}}">
                <input type="submit" id="submit-test-send" class="display-none" />
                <ul>
                    <li>
                        <div class="item-content item-input">
                            <div class="item-media text-color-lightgray">
                                <i class="f7-icons icon-day-of-week"></i>
                            </div>
                            <div class="item-inner">
                                <div class="item-title item-floating-label item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG03}}</div>
                                <div class="item-input-wrap">
                                    <input type="text" placeholder="Select date and time" readonly="readonly" name="beginTime" />
                                </div>
                            </div>
                        </div>
                    </li>
                    <li >
                        <a class="item-link smart-select smart-select-init smart-select-custom smart-select-test-type" data-open-in="popover" data-close-on-select="true" data-form-color-theme="green">
                            <select name="diagnoseType" multiple maxlength="1" required validate >
                                {{#each TestTypeList}}
                                <option value="{{Val}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                {{/each}}
                            </select>
                            <div class="item-content ">
                                <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-labname"></i>--></div>
                                <div class="item-inner">
                                    <div class="item-title ">{{@global.LANGUAGE.UNIT_TEST_RESULT_MSG007}}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><i class="f7-icons icon-labname"></i></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG01}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="organizeName" value="{{OrganizeInfo.name}}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><i class="f7-icons icon-name"></i></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG04}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="doctorFirstName" value="{{DoctorInfo.firstName}}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-phone"></i>--></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG05}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="doctorSubName" value="{{DoctorInfo.subName}}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li>
                        <a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-scroll-to-selected-item="true" data-form-color-theme="green">
                            <select name="provinceID" required validate>
                                {{#each ProvinceList}}
                                <option value="{{Val}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                {{/each}}
                            </select>
                            <div class="item-content">
                                <div class="item-media text-color-lightgray">
                                    <i class="f7-icons icon-tracking"></i>
                                </div>
                                <div class="item-inner">
                                    <div class="item-title ">{{@global.LANGUAGE.REGISTRATION_MSG09}}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-scroll-to-selected-item="true" data-form-color-theme="green">
                            <select name="cityID" required validate>
                                {{#each CityList}}
                                <option value="{{Val}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                {{/each}}
                            </select>
                            <div class="item-content">
                                <div class="item-media text-color-lightgray">
                                    <!-- <i class="f7-icons icon-timing"></i>-->
                                </div>
                                <div class="item-inner">
                                    <div class="item-title ">{{@global.LANGUAGE.REGISTRATION_MSG10}}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-name"></i>--></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.REGISTRATION_MSG12}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="organizeStreet" value="{{OrganizeInfo.street}}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <!--<li >
                        <a @click="showAddressMap" href="#" class="item-link item-content">
                            <div class="item-media text-color-lightgray"><i class="f7-icons icon-tracking"></i></div>
                            <div class="item-inner">
                                <div class="item-title">
                                    <div class="item-header text-color-gray">{{@global.LANGUAGE.REGISTRATION_MSG16}}</div>
                                    {{Address}}
                                </div>
                            </div>
                        </a>
                    </li>-->

                </ul>
            </form>
        </div>

    </div>



</template>


<script>
    // script must return component object
    return {
        data: function () {
            let self = this;
            let userInfo = self.$app.methods.getFromStorage('userInfo');
            let provinceList = Helper.Methods.getProvinceList();
            let cityList = Helper.Methods.getCityList();
            let awaitingState = userInfo.diagnoseInfo && userInfo.diagnoseInfo.state === 0;
            if(awaitingState){
                if(userInfo.organizeInfo && userInfo.organizeInfo.proviceID){
                    provinceList.find( ({ Val }) => Val === userInfo.organizeInfo.proviceID ).Selected = true;
                }
                if(userInfo.organizeInfo && userInfo.organizeInfo.cityID){
                    cityList.find( ({ Val }) => Val === userInfo.organizeInfo.cityID ).Selected = true;
                }
            }else{
                provinceList.find( ({ Val }) => Val === userInfo.contactInfo.provinceID ).Selected = true;
                cityList.find( ({ Val }) => Val === userInfo.contactInfo.cityID ).Selected = true;
            }

            let testTypeList = Helper.Methods.getTestTypeList();

            let ret = {
                DiagnoseStateAwaitingReview: awaitingState,
                ProvinceList: provinceList,
                CityList: cityList,
                TestTypeList: testTypeList,
                DiagnoseInfo: userInfo.diagnoseInfo ? userInfo.diagnoseInfo : {},
                DoctorInfo: userInfo.doctorInfo ? userInfo.doctorInfo : {},
                OrganizeInfo: userInfo.organizeInfo ? userInfo.organizeInfo : {},
           };

            return ret;
        },

        methods: {
            showAddressMap: function () {
                let self = this;
                let data = {};
                self.$app.methods.showAddressMap(data, function (params) {
                    if(params.displayAddress){
                        self.$setState({
                            Address: params.displayAddress
                        });

                    }
                });
            },

        },

        on: {
            pageInit: function (e, page) {
                let self = this;

                let form = page.$el.find('[name = "FormTestSend"]');
                let testDateEl = page.$el.find('[name="beginTime"]');

                let testDate = moment().format(window.COM_TIMEFORMAT6);
                if(self.DiagnoseInfo && self.DiagnoseInfo.state >= 0 && self.DiagnoseInfo.beginTime){
                    testDate = moment(self.DiagnoseInfo.beginTime, window.COM_TIMEFORMAT2).add(self.$app.data.UTCOFFSET).format(window.COM_TIMEFORMAT6);
                }
                console.log(self.DiagnoseInfo)
                self.CalendarTestDate = self.$app.calendar.create({
                    inputEl: testDateEl,
                    timePicker: true,
                    dateFormat: window.COM_TIMEFORMAT7,
                    value: [testDate],
                    maxDate: new Date(),
                });

                form.on('submit', function(e){
                    e.preventDefault();

                    /*let data = {
                        Token: self.$app.data.Token,
                        BeginTime: moment.utc(self.CalendarTestDate.getValue()[0]).format(window.COM_TIMEFORMAT2),
                        DiagnoseType: page.$el.find('[name = "DiagnoseType"]').val().toString(),
                        OrganizeCode: '',
                        OrganizeName: page.$el.find('[name = "LabName"]').val(),
                        DoctorFirstName: page.$el.find('[name = "LabDocFirstName"]').val(),
                        DoctorSubName: page.$el.find('[name = "LabDocLastName"]').val(),

                        ProvinceID: page.$el.find('[name = "Province"]').val(),
                        CityID: page.$el.find('[name = "City"]').val(),
                        Street: page.$el.find('[name = "Street"]').val(),
                    };*/
                    let data = self.$app.form.convertToData(form);
                    data.Token = self.$app.data.Token;

                    if(data.beginTime){
                        data.beginTime = moment(data.beginTime,window.COM_TIMEFORMAT6).utc().format(window.COM_TIMEFORMAT2);
                    }
                    if(data.diagnoseType){
                        data.diagnoseType = data.diagnoseType.toString();
                    }
                    data.Street = data.organizeStreet;


                    self.$app.progressbar.show();
                    self.$app.request.promise.post(API_URL.NOTIFY_TEST, data, 'json')
                        .then(function (result) {
                            console.log(result.data);
                            if(result.data.majorCode === '000') {
                                let userInfo = self.$app.methods.getFromStorage('userInfo');
                                userInfo.diagnoseInfo = result.data.data;
                                self.$app.methods.setInStorage({name:'userInfo', data:userInfo});
                                self.$app.methods.customNotification({text:LANGUAGE.PROMPT_MSG032});

                                let diagnoseInfoDescr = Helper.Methods.getDiagnoseInfoDescr(result.data.data);
                                self.$app.data.Covid19StatusType = diagnoseInfoDescr.type;
                                self.$app.data.Covid19Status = diagnoseInfoDescr.text;

                                AppEvents.emit('covidStatusChanged', {
                                    Covid19StatusType: diagnoseInfoDescr.type,
                                    Covid19Status: diagnoseInfoDescr.text,
                                    StatusDaysCount: diagnoseInfoDescr.beginTimeDaysCount ? diagnoseInfoDescr.beginTimeDaysCount : 0
                                });
                                self.$app.view.main.router.back();

                            }else if(result.data.majorCode && result.data.data && result.data.data.length){
                                let errMsg = '';
                                for (let i = 0; i < result.data.data.length; i++) {
                                    if(result.data.data[i].messages.length){
                                        errMsg += result.data.data[i].key + ' - ' + result.data.data[i].messages.join(", ") + '<br>';
                                    }
                                }
                                self.$app.methods.customDialog({ title: LANGUAGE.PROMPT_MSG071, text: errMsg });
                            }else if(result.data.data && typeof result.data.data == 'string' ){
                                self.$app.methods.customDialog({ title: LANGUAGE.PROMPT_MSG071, text: result.data.data });
                            }else{
                                self.$app.methods.customDialog({ text: LANGUAGE.PROMPT_MSG003 });
                            }


                        })
                        .finally(function () {
                            self.$app.progressbar.hide();
                        })
                        .catch(function (err) {
                            console.log(err);
                            if (err && err.status === 404){
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG002);
                            }else{
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG003);
                            }
                        });
                    return false;
                });



            },
            pageBeforeRemove: function () {
                let self = this;
                if (self.CalendarTestDate) {
                    self.CalendarTestDate.destroy();
                }

            }

        }
    };
</script>
