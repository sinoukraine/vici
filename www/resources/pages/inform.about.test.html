<!--suppress JSAnnotator -->
<template>
    <!-- Page, data-name contains page name which can be used in callbacks -->
    <div class="page " > <!-- page-with-subnavbar -->
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                    </a>
                </div>
                <div class="title sliding">{{@global.LANGUAGE.INFORM_ABOUT_MSG00}}</div>
                <div class="right">
                    <label for="submit-test-send" class="link icon-only">
                        <i class="f7-icons icon-apply"></i>
                    </label>
                </div>
            </div>
        </div>


        <div  class="page-content" >
         <!--   <div class="block-title">{{@global.LANGUAGE.DEVICE_SHARE_MSG00}}</div>-->
            <div class="block">
                {{@global.LANGUAGE.PROMPT_MSG033}}
            </div>
            <form name="FormTestSend" class="list no-hairlines no-margin-bottom">
                <input type="submit" id="submit-test-send" class="display-none" />
                <ul>
                    <li>
                        <div class="item-content item-input">
                            <div class="item-media text-color-lightgray">
                                <i class="f7-icons icon-day-of-week"></i>
                            </div>
                            <div class="item-inner">
                                <div class="item-title item-floating-label item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG03}}</div>
                                <div class="item-input-wrap">
                                    <input type="text" placeholder="Select date and time" readonly="readonly" name="TestDate" />
                                </div>
                            </div>
                        </div>
                    </li>
                    <li >
                        <a class="item-link smart-select smart-select-init smart-select-custom smart-select-test-type" data-open-in="popover" data-close-on-select="true" data-form-color-theme="green">
                            <select name="DiagnoseType" multiple maxlength="1" required validate >
                                {{#each TestTypeList}}
                                <option value="{{Val}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                {{/each}}
                            </select>
                            <div class="item-content ">
                                <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-labname"></i>--></div>
                                <div class="item-inner">
                                    <div class="item-title ">{{@global.LANGUAGE.UNIT_TEST_RESULT_MSG007}}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><i class="f7-icons icon-labname"></i></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG01}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="LabName" value="" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><i class="f7-icons icon-name"></i></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG04}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="LabDocFirstName" value="" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-phone"></i>--></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.INFORM_ABOUT_MSG05}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="LabDocLastName" value="" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li>
                        <a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-scroll-to-selected-item="true" data-form-color-theme="green">
                            <select name="Province" required validate>
                                {{#each ProvinceList}}
                                <option value="{{Val}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                {{/each}}
                            </select>
                            <div class="item-content">
                                <div class="item-media text-color-lightgray">
                                    <i class="f7-icons icon-tracking"></i>
                                </div>
                                <div class="item-inner">
                                    <div class="item-title ">{{@global.LANGUAGE.REGISTRATION_MSG09}}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li>
                        <a class="item-link smart-select smart-select-init" data-open-in="popup" data-searchbar="true" data-close-on-select="true" data-scroll-to-selected-item="true" data-form-color-theme="green">
                            <select name="City" required validate>
                                {{#each CityList}}
                                <option value="{{Val}}" {{#if Selected}}selected{{/if}}>{{Name}}</option>
                                {{/each}}
                            </select>
                            <div class="item-content">
                                <div class="item-media text-color-lightgray">
                                    <!-- <i class="f7-icons icon-timing"></i>-->
                                </div>
                                <div class="item-inner">
                                    <div class="item-title ">{{@global.LANGUAGE.REGISTRATION_MSG10}}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-media text-color-lightgray"><!--<i class="f7-icons icon-name"></i>--></div>
                        <div class="item-inner">
                            <div class="item-title item-label">{{@global.LANGUAGE.REGISTRATION_MSG12}}</div>
                            <div class="item-input-wrap">
                                <input type="text" name="Street" value="" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <!--<li >
                        <a @click="showAddressMap" href="#" class="item-link item-content">
                            <div class="item-media text-color-lightgray"><i class="f7-icons icon-tracking"></i></div>
                            <div class="item-inner">
                                <div class="item-title">
                                    <div class="item-header text-color-gray">{{@global.LANGUAGE.REGISTRATION_MSG16}}</div>
                                    {{Address}}
                                </div>
                            </div>
                        </a>
                    </li>-->

                </ul>
            </form>
        </div>

    </div>



</template>


<script>
    // script must return component object
    return {
        data: function () {
            let self = this;
            let userInfo = self.$app.methods.getFromStorage('userInfo');
            let provinceList = Helper.Methods.getProvinceList();
            let cityList = Helper.Methods.getCityList();
            provinceList.find( ({ Val }) => Val === userInfo.contactInfo.provinceID ).Selected = true;
            cityList.find( ({ Val }) => Val === userInfo.contactInfo.cityID ).Selected = true;
            let testTypeList = Helper.Methods.getTestTypeList();

            let ret = {
                ProvinceList: provinceList,
                CityList: cityList,
                TestTypeList: testTypeList,
           };

            return ret;
        },

        methods: {
            showAddressMap: function () {
                let self = this;
                let data = {};
                self.$app.methods.showAddressMap(data, function (params) {
                    if(params.displayAddress){
                        self.$setState({
                            Address: params.displayAddress
                        });

                    }
                });
            },

        },

        on: {
            pageInit: function (e, page) {
                let self = this;

                let form = page.$el.find('[name = "FormTestSend"]');
                let testDateEl = page.$el.find('[name="TestDate"]');
                self.CalendarTestDate = self.$app.calendar.create({
                    inputEl: testDateEl,
                    timePicker: true,
                    dateFormat: 'MM dd yyyy, HH::mm',
                    value: [moment().format('MMMM DD YYYY, HH:mm')],
                    maxDate: new Date(),
                });

                form.on('submit', function(e){
                    e.preventDefault();

                    let data = {
                        Token: self.$app.data.Token,
                        BeginTime: moment.utc(self.CalendarTestDate.getValue()[0]).format(window.COM_TIMEFORMAT2),
                        DiagnoseType: page.$el.find('[name = "DiagnoseType"]').val().toString(),
                        OrganizeCode: '',
                        OrganizeName: page.$el.find('[name = "LabName"]').val(),
                        DoctorFirstName: page.$el.find('[name = "LabDocFirstName"]').val(),
                        DoctorSubName: page.$el.find('[name = "LabDocLastName"]').val(),

                        ProvinceID: page.$el.find('[name = "Province"]').val(),
                        CityID: page.$el.find('[name = "City"]').val(),
                        Street: page.$el.find('[name = "Street"]').val(),

                    };


                    self.$app.progressbar.show();
                    self.$app.request.promise.post(API_URL.NOTIFY_TEST, data, 'json')
                        .then(function (result) {
                            console.log(result.data);
                            if(result.data.majorCode === '000') {
                                let userInfo = self.$app.methods.getFromStorage('userInfo');
                                userInfo.diagnoseInfo = result.data.data;
                                self.$app.methods.setInStorage({name:'userInfo', data:userInfo});
                                self.$app.methods.customNotification({text:LANGUAGE.PROMPT_MSG032});

                                let stateDescr = Helper.Methods.covid19Enum(result.data.data.state);

                                self.$app.data.Covid19StatusType = result.data.data.state;
                                self.$app.data.Covid19Status = stateDescr.text;

                                AppEvents.emit('covidStatusChanged', {
                                    Covid19StatusType: result.data.data.state,
                                    Covid19Status: stateDescr.text,
                                    Covid19StatusDate: moment(result.data.data.beginTime,window.COM_TIMEFORMAT2).add(self.$app.data.UTCOFFSET,'minutes').format(window.COM_TIMEFORMAT4),
                                   // StatusDaysCount: moment().diff(self.CalendarTestDate.getValue()[0], 'days')
                                });
                                self.$app.view.main.router.back();

                            }else if(result.data.majorCode && result.data.data && result.data.data.length){
                                let errMsg = '';
                                for (let i = 0; i < result.data.data.length; i++) {
                                    if(result.data.data[i].messages.length){
                                        errMsg += result.data.data[i].key + ' - ' + result.data.data[i].messages.join(", ") + '<br>';
                                    }
                                }
                                self.$app.methods.customDialog({ title: LANGUAGE.PROMPT_MSG071, text: errMsg });
                            }else if(result.data.data && typeof result.data.data == 'string' ){
                                self.$app.methods.customDialog({ title: LANGUAGE.PROMPT_MSG071, text: result.data.data });
                            }else{
                                self.$app.methods.customDialog({ text: LANGUAGE.PROMPT_MSG003 });
                            }


                        })
                        .finally(function () {
                            self.$app.progressbar.hide();
                        })
                        .catch(function (err) {
                            console.log(err);
                            if (err && err.status === 404){
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG002);
                            }else{
                                self.$app.dialog.alert(LANGUAGE.PROMPT_MSG003);
                            }
                        });
                    return false;
                });



            },
            pageBeforeRemove: function () {
                let self = this;
                if (self.CalendarTestDate) {
                    self.CalendarTestDate.destroy();
                }

            }

        }
    };
</script>
